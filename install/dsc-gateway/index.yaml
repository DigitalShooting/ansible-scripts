---
- hosts: dsv
  vars_files:
    - ../../config/{{type}}.yaml

  tasks:
  - name: Installing git, npm and nodejs
    apt: name={{item}} state=latest
    with_items:
    - git
    - nodejs
    - npm
    sudo: yes

  - name: Adding user dsc-gateway
    user: name=dsc-gateway shell=/bin/bash
    sudo: yes

  - name: Pulling dsc-gateway repo
    git: repo={{dsc_gateway_repo}} dest=/home/dsc-gateway/dsc-gateway/ force=yes version={{dsc_gateway_version}}
    become: yes
    become_user: dsc-gateway
  - name: NPM Install in dsc-gateway
    npm: path=/home/dsc-gateway/dsc-gateway/
    become: yes
    become_user: dsc-gateway
  - name: Setting dsc-gateway Settings
    template: src=config/{{item}} dest=/home/dsc-gateway/dsc-gateway/config/{{item}}
    become: yes
    become_user: dsc-gateway
    with_items:
    - network.js
    - lines.js

  - name: Seting up dsc-gateway systemd service
    template: src=other/dsc-gateway.service dest=/etc/systemd/system/dsc-gateway.service owner=root group=root
    sudo: yes
  - name: Reload systemd
    command: systemctl daemon-reload
    sudo: yes
  - name: Restarting dsc-gateway systemd service
    service: name=dsc-gateway state=restarted enabled=yes
    sudo: yes
