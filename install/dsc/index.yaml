---
- hosts: dsc
  vars_files:
    - ../../config/{{type}}.yaml

  tasks:
    # install deps
  - name: Install git, npm, nodejs, mysql
    apt: name={{item}} state=latest
    with_items:
    - git
    - nodejs
    - npm
    - mysql-server
    - python-mysqldb
    sudo: yes

    # create user dsc
  - name: Adding user dsc
    user: name=dsc shell=/bin/bash
    sudo: yes
  - name: Adding user dsc to dialout group...
    user: name=dsc state=present groups="dialout"
    sudo: yes

    # install main dsc
  - name: Pulling dsc repo
    git: repo={{dsc_repo}} dest=/home/dsc/dsc/ force=yes version={{dsc_version}}
    become: yes
    become_user: dsc
  - name: NPM Install in dsc
    npm: path=/home/dsc/dsc/
    become: yes
    become_user: dsc
  - name: Make haering lib
    command: bash -c "cd /home/dsc/dsc/lib/Haering/ && ./buildAPI.sh"
    become: yes
  - name: Update vaersion.tmp
    command: bash -c "cd /home/dsc/dsc/config/ && ./setVersion.sh"
    become: yes
    become_user: dsc
  - name: Set up dsc config
    template: src=config/{{item}} dest=/home/dsc/dsc/config/{{item}}
    become: yes
    become_user: dsc
    with_items:
    - line.js
    - auth.js
    - database.js
  - name: Copy logo
    copy: src=../../config/logo.png dest=/home/dsc/dsc/config/logo.png
    become: yes
    become_user: dsc

    # install mysql
  - name: Configure mysql root
    mysql_user: name=root host={{ item }} password={{ mysql_root_password }} priv=*.*:ALL,GRANT
    with_items:
    - "{{ ansible_hostname }}"
    - 127.0.0.1
    - ::1
    - localhost
    sudo: yes
  - name: copy .my.cnf file with root password credentials
    template: src=mysql/my.cnf dest=/root/.my.cnf owner=root group=root mode=0600
    sudo: yes
  - mysql_db: name=mysql state=import target=/home/dsc/dsc/install/database.sql
    sudo: yes
    ignore_errors: yes

    # configure mysql
  - name: copy dsc setPassword SQL file
    template: src=mysql/setPassword.sql dest=/tmp/setPassword.sql owner=root group=root mode=0600
    sudo: yes
  - mysql_db: name=mysql state=import target=/tmp/setPassword.sql
    sudo: yes
  - name: Copy MySQL cnf
    template: src=mysql/my.server.cnf dest=/etc/mysql/my.cnf owner=root group=root mode=0600
    sudo: yes
  - name: Restart the MySQL service
    action: service name=mysql state=restarted enabled=true
    sudo: yes

    # create service for dsc and start
  - name: Set up dsc systemd service
    template: src=other/dsc.service dest=/etc/systemd/system/dsc.service owner=root group=root
    sudo: yes
  - name: Reload systemd
    command: systemctl daemon-reload
    sudo: yes
  - name: Restart & enable dsc systemd service
    service: name=dsc state=restarted enabled=yes
    sudo: yes
